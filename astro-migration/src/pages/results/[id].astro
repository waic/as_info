---
/**
 * テスト結果ページ
 * 元: pages/results/[id].tsx
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import Logo from '../../components/Logo.astro';
import H1 from '../../components/H1.astro';
import Navigation from '../../components/Navigation.astro';
import { getCriteria, getTechs, getTests, getResults, getMetadata } from '../../lib/data';
import { getCriterionLevel, sortByResultId, type ResultData, type ResultContent } from '../../lib/utils';

export async function getStaticPaths() {
  const { getEntry } = await import('astro:content');
  const testsEntry = await getEntry('tests', 'tests');
  const tests = testsEntry?.data ?? {};

  return Object.keys(tests).map((id) => ({
    params: { id },
    props: { testId: id },
  }));
}

interface Props {
  testId: string;
}

const { testId } = Astro.props;

const metadata = await getMetadata();
const criteria = await getCriteria();
const techs = await getTechs();
const tests = await getTests();
const results = await getResults();

const test = tests[testId];
const criterionIds = test.criteria;
const techIds = test.techs;
const resultIds = results.filter((result: ResultData) => result.test === testId).sort(sortByResultId);
const base = import.meta.env.BASE_URL;

// ヘルパー関数
function getTesterName(result: ResultData): string {
  return result.tester ?? '不明';
}

function getDate(result: ResultData): string {
  return result.date ?? '不明';
}

function getJudgment(content: ResultContent): string {
  switch (content.judgment) {
    case '満たしている':
      return '○';
    case '満たしていない':
      return '×';
    default:
      return content.judgment ?? '';
  }
}

function getComments(result: ResultData): string {
  let comments = '';
  if (result.comment) {
    comments += result.comment;
  }
  if (result.reviewer_comment) {
    if (comments.length > 0) {
      comments += '\n';
    }
    comments += result.reviewer_comment;
  }
  return comments;
}

function isInReview(resultId: number): boolean {
  return resultId > metadata.last_reviewed_result_id;
}

const largerThStyle = 'min-width: 6em; max-width: 10em; overflow-wrap: break-word;';
const listItemStyle = 'overflow-wrap: break-word;';
---

<BaseLayout title={`テスト${testId}`}>
  <Logo />
  <main id="main">
    <H1
      first="アクセシビリティ サポーテッド (AS) 情報：テストケース"
      second={`${testId}: ${test.title}`}
    />
    <ul>
      <li>作成者：{metadata.author}</li>
      {metadata.status && <li>注記：{metadata.status}</li>}
    </ul>

    <h2>テストの対象となる達成基準</h2>
    <ul>
      {criterionIds.map((criterionId: string) => (
        <li>
          <a href={`${base}criteria/${criterionId}/`}>
            {criterionId}
            {' '}
            {criteria[criterionId].title}
            {' '}
            {getCriterionLevel(criteria[criterionId])}
            {' '}
            に関連するAS情報
          </a>
        </li>
      ))}
    </ul>

    <h2>関連する達成方法(テクニック)</h2>
    {techIds.length > 0 ? (
      <ul>
        {techIds.map((techId: string) => (
          <li>
            <a href={`${base}techs/${techId}/`}>
              {techId}:「{techs[techId].title}」に関連するAS情報
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <div>なし</div>
    )}

    <h2>テスト詳細</h2>
    <ul>
      <li><a href={test.document}>テストケース {testId} の詳細を表示</a></li>
      <li>
        {typeof test.code === 'string' ? (
          <a href={test.code}>テストコード {testId} をユーザーエージェントで表示</a>
        ) : (
          <>
            <div>テストコード {testId} をユーザーエージェントで表示</div>
            <ul>
              {test.code.map((item: string, index: number) => (
                <li><a href={item}>{item.split('/').slice(-1)[0]}</a></li>
              ))}
            </ul>
          </>
        )}
      </li>
    </ul>

    <h2>検証結果一覧</h2>
    <ul>
      <li>テスト結果の件数: {resultIds.length}件</li>
    </ul>

    {resultIds.length > 0 && (
      <>
        <h3>テスト結果の詳細</h3>
        <table tabindex="0">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">環境</th>
              <th scope="col">判断</th>
              <th scope="col">操作内容</th>
              <th scope="col">得られた結果</th>
              <th scope="col">テスト実施者</th>
              <th scope="col">実施日</th>
              <th scope="col">備考</th>
            </tr>
          </thead>
          <tbody>
            {[...resultIds].reverse().map((result: ResultData) => {
              const contents = result.contents;
              if (contents.length === 1) {
                return (
                  <tr>
                    <th scope="row">{result.id}</th>
                    <td style={largerThStyle}>
                      <ul>
                        <li style={listItemStyle}>{result.os}</li>
                        <li style={listItemStyle}>{result.user_agent}</li>
                        {result.assistive_tech && <li style={listItemStyle}>{result.assistive_tech}</li>}
                        {result.assistive_tech_config && (
                          <li style={listItemStyle}>
                            {result.assistive_tech_config.split('\n').map((line: string, i: number) => (
                              <p>{line}</p>
                            ))}
                          </li>
                        )}
                      </ul>
                    </td>
                    <td>{getJudgment(contents[0])}</td>
                    <td style={largerThStyle}>
                      {contents[0].procedure?.split('\n').map((line: string) => <p>{line}</p>)}
                    </td>
                    <td style={largerThStyle}>
                      {contents[0].actual?.split('\n').map((line: string) => <p>{line}</p>)}
                    </td>
                    <td style={largerThStyle}>{getTesterName(result)}</td>
                    <td style={largerThStyle}>{getDate(result)}</td>
                    <td style={largerThStyle}>
                      {isInReview(result.id) && <span>[WAICレビュー作業中]</span>}
                      {getComments(result).split('\n').map((line: string) => <p>{line}</p>)}
                    </td>
                  </tr>
                );
              }
              return contents.map((item: ResultContent, index: number) => (
                <tr>
                  {index === 0 && (
                    <>
                      <th rowspan={contents.length} scope="rowgroup">{result.id}</th>
                      <td rowspan={contents.length} style={largerThStyle}>
                        <ul>
                          <li style={listItemStyle}>{result.os}</li>
                          <li style={listItemStyle}>{result.user_agent}</li>
                          {result.assistive_tech && <li style={listItemStyle}>{result.assistive_tech}</li>}
                          {result.assistive_tech_config && (
                            <li style={listItemStyle}>
                              {result.assistive_tech_config.split('\n').map((line: string) => <p>{line}</p>)}
                            </li>
                          )}
                        </ul>
                      </td>
                    </>
                  )}
                  <td>{getJudgment(item)}</td>
                  <td style={largerThStyle}>
                    {item.procedure?.split('\n').map((line: string) => <p>{line}</p>)}
                  </td>
                  <td style={largerThStyle}>
                    {item.actual?.split('\n').map((line: string) => <p>{line}</p>)}
                  </td>
                  {index === 0 && (
                    <>
                      <td rowspan={contents.length} style={largerThStyle}>{getTesterName(result)}</td>
                      <td rowspan={contents.length} style={largerThStyle}>{getDate(result)}</td>
                      <td rowspan={contents.length} style={largerThStyle}>
                        {isInReview(result.id) && <span>[WAICレビュー作業中]</span>}
                        {getComments(result).split('\n').map((line: string) => <p>{line}</p>)}
                      </td>
                    </>
                  )}
                </tr>
              ));
            })}
          </tbody>
        </table>
      </>
    )}

    <h2>ライセンス</h2>
    <p>各検証結果は、それぞれの作成者を原著作者とし、クリエイティブ・コモンズ・ライセンスの下でライセンスされています。原著作者名は、それぞれの検証結果をご覧ください。また、ご利用になる前に利用許諾条項を必ずご確認ください。</p>
    <p>
      <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.ja">
        <img
          src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/by-sa.png"
          alt="by-sa"
          width="88"
          height="31"
        />
        利用許諾条項（表示 – 継承 4.0 国際）の確認
      </a>
    </p>
  </main>

  <Navigation />
</BaseLayout>
